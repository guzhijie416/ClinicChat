/**
 * @fileoverview Firestore Security Rules for the ClinicChat application.
 *
 * Core Philosophy:
 * This ruleset provides secure access to clinic data, FAQs, staff information, and chat sessions. It uses path-based rules and denormalization to enforce
 * access control efficiently. Public read access is granted for clinic listings, while all other data is secured using an owner-like model based on the clinic ID.
 *
 * Data Structure:
 * - /clinics/{clinicId}: Stores general clinic information (name, address, contact). Intended for public listing.
 * - /clinics/{clinicId}/faqs/{faqId}: Stores frequently asked questions for each clinic. Secured to prevent unauthorized modification.
 * - /clinics/{clinicId}/staff/{staffId}: Stores staff details. Access is restricted to authorized clinic users.
 * - /clinics/{clinicId}/chat_sessions/{chatSessionId}: Stores chat sessions for a clinic.
 * - /clinics/{clinicId}/chat_sessions/{chatSessionId}/messages/{messageId}: Stores individual chat messages within a session.
 *
 * Key Security Decisions:
 * - Clinic listing is public, but modification requires authorization (TODO: implement).
 * - FAQs, staff, chat sessions, and chat messages are secured to the specific clinic using the `clinicId` field within each document, which is validated on write.
 * - No user listing is allowed.
 *
 * Denormalization for Authorization:
 * The `clinicId` is denormalized (copied) into the FAQ, Staff, ChatSession, and ChatMessage documents. This avoids costly `get()` calls in security rules and allows each document to be independently secured.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows listing clinics with public info (name, address, hours, phone).  Creation, modification, and deletion are currently denied.
     * @path /clinics/{clinicId}
     * @allow get, list: if true;
     * @deny create: if false;
     * @deny update: if false;
     * @deny delete: if false;
     * @principle Grants public read access to clinic listings but restricts write access.
     */
    match /clinics/{clinicId} {
      allow get, list: if true;
      allow create: if false; // TODO: Add clinic creation logic for authorized users.
      allow update: if false; // TODO: Add clinic update logic for authorized users.
      allow delete: if false; // TODO: Add clinic deletion logic for authorized users.
    }

    /**
     * @description Controls access to FAQs, ensuring only authorized users can create, modify, or delete them within a specific clinic.  Validates that the 'clinicId' matches the path.
     * @path /clinics/{clinicId}/faqs/{faqId}
     * @allow create: if request.resource.data.clinicId == clinicId;
     * @allow get, list: if true; // TODO: Restrict get/list to authorized clinic users.
     * @allow update: if resource.data.clinicId == clinicId;
     * @allow delete: if resource.data.clinicId == clinicId;
     * @deny create: if request.resource.data.clinicId != clinicId;
     * @deny update: if resource.data.clinicId != clinicId;
     * @deny delete: if resource.data.clinicId != clinicId;
     * @principle Enforces data consistency by validating the 'clinicId' against the path and restricts write access based on this relationship.
     */
    match /clinics/{clinicId}/faqs/{faqId} {
      allow get, list: if true; // TODO: Restrict get/list to authorized clinic users.
      allow create: if request.resource.data.clinicId == clinicId;
      allow update: if resource.data.clinicId == clinicId && resource != null;
      allow delete: if resource.data.clinicId == clinicId && resource != null;
    }

    /**
     * @description Manages staff information for a clinic. Ensures the 'clinicId' matches the path and restricts modifications to authorized clinic users.
     * @path /clinics/{clinicId}/staff/{staffId}
     * @allow create: if request.resource.data.clinicId == clinicId;
     * @allow get, list: if true; // TODO: Restrict get/list to authorized clinic users.
     * @allow update: if resource.data.clinicId == clinicId;
     * @allow delete: if resource.data.clinicId == clinicId;
     * @deny create: if request.resource.data.clinicId != clinicId;
     * @deny update: if resource.data.clinicId != clinicId;
     * @deny delete: if resource.data.clinicId != clinicId;
     * @principle Validates the 'clinicId' against the path for data consistency and restricts write access to enforce staff data ownership by the clinic.
     */
    match /clinics/{clinicId}/staff/{staffId} {
      allow get, list: if true; // TODO: Restrict get/list to authorized clinic users.
      allow create: if request.resource.data.clinicId == clinicId;
      allow update: if resource.data.clinicId == clinicId && resource != null;
      allow delete: if resource.data.clinicId == clinicId && resource != null;
    }

    /**
     * @description Secures chat sessions to the clinic and participating users.  Validates that the 'clinicId' matches the path.
     * @path /clinics/{clinicId}/chat_sessions/{chatSessionId}
     * @allow create: if request.resource.data.clinicId == clinicId;
     * @allow get, list: if true; // TODO: Restrict get/list to authorized clinic users.
     * @allow update: if resource.data.clinicId == clinicId;
     * @allow delete: if resource.data.clinicId == clinicId;
     * @deny create: if request.resource.data.clinicId != clinicId;
     * @deny update: if resource.data.clinicId != clinicId;
     * @deny delete: if resource.data.clinicId != clinicId;
     * @principle Enforces data consistency by validating the 'clinicId' against the path and restricts write access based on this relationship.
     */
    match /clinics/{clinicId}/chat_sessions/{chatSessionId} {
      allow get, list: if true; // TODO: Restrict get/list to authorized clinic users.
      allow create: if request.resource.data.clinicId == clinicId;
      allow update: if resource.data.clinicId == clinicId && resource != null;
      allow delete: if resource.data.clinicId == clinicId && resource != null;
    }

    /**
     * @description Secures chat messages within a chat session. Validates 'clinicId' and 'chatSessionId' against their respective paths.
     * @path /clinics/{clinicId}/chat_sessions/{chatSessionId}/messages/{messageId}
     * @allow create: if request.resource.data.clinicId == clinicId && request.resource.data.chatSessionId == chatSessionId;
     * @allow get, list: if true; // TODO: Restrict get/list to authorized clinic users.
     * @allow update: if resource.data.clinicId == clinicId && resource.data.chatSessionId == chatSessionId;
     * @allow delete: if resource.data.clinicId == clinicId && resource.data.chatSessionId == chatSessionId;
     * @deny create: if request.resource.data.clinicId != clinicId || request.resource.data.chatSessionId != chatSessionId;
     * @deny update: if resource.data.clinicId != clinicId || resource.data.chatSessionId != chatSessionId;
     * @deny delete: if resource.data.clinicId != clinicId || resource.data.chatSessionId != chatSessionId;
     * @principle Enforces relational integrity by validating the 'clinicId' and 'chatSessionId' against the path and restricts write access based on these relationships.
     */
    match /clinics/{clinicId}/chat_sessions/{chatSessionId}/messages/{messageId} {
      allow get, list: if true; // TODO: Restrict get/list to authorized clinic users.
      allow create: if request.resource.data.clinicId == clinicId && request.resource.data.chatSessionId == chatSessionId;
      allow update: if resource.data.clinicId == clinicId && resource.data.chatSessionId == chatSessionId && resource != null;
      allow delete: if resource.data.clinicId == clinicId && resource.data.chatSessionId == chatSessionId && resource != null;
    }
  }
}