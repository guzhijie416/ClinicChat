/**
 * @fileoverview Firestore Security Rules for the ClinicChat application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict clinic-based data isolation model. Each clinic's
 * data (staff, FAQs, chat sessions, and messages) is stored under its unique ID.
 * Access is restricted based on clinic ownership, ensuring that users can only
 * access data associated with their clinic.
 *
 * Data Structure:
 * The Firestore database is structured as follows:
 * /clinics/{clinicId} - Stores clinic information.
 * /clinics/{clinicId}/staff/{staffId} - Stores staff information for a clinic.
 * /clinics/{clinicId}/faqs/{faqId} - Stores FAQs for a clinic.
 * /clinics/{clinicId}/chatSessions/{chatSessionId} - Stores chat sessions for a clinic.
 * /clinics/{clinicId}/chatSessions/{chatSessionId}/chatMessages/{chatMessageId} - Stores chat messages for a session.
 *
 * Key Security Decisions:
 * - All data is namespaced under a clinic ID, enforcing data isolation.
 * - Write access to any clinic-owned data requires the user to be authenticated.
 * - Listing of documents is generally allowed within a clinic's subcollections
 *   (staff, FAQs, chatSessions).
 *
 * Denormalization for Authorization:
 * The `clinicId` is present on all subcollection documents (staff, FAQs, chatSessions, chatMessages).
 * This allows us to verify that a document belongs to the correct clinic without
 * performing additional `get()` operations.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to clinic documents.
     * @path /clinics/{clinicId}
     * @allow (create) - Authenticated user can create a clinic with a matching clinicId.
     * @allow (get, list) - Read access is allowed for all.
     * @allow (update, delete) - Authenticated user can update/delete a clinic with a matching clinicId.
     * @deny (create) - Unauthenticated user cannot create a clinic.
     * @deny (update, delete) - Unauthenticated user cannot update/delete a clinic.
     * @principle Enforces clinic ownership for writes.
     */
    match /clinics/{clinicId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(clinicId) {
        return request.auth.uid == clinicId;
      }

      function isExistingOwner(clinicId) {
        return isOwner(clinicId) && resource != null;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && isOwner(clinicId);
      allow update: if isExistingOwner(clinicId);
      allow delete: if isExistingOwner(clinicId);
    }

    /**
     * @description Controls access to staff documents within a clinic.
     * @path /clinics/{clinicId}/staff/{staffId}
     * @allow (create) - Authenticated user can create a staff document in the clinic if the clinicId matches.
     * @allow (get, list) - Read access is allowed for all authenticated users of the clinic.
     * @allow (update, delete) - Authenticated user can update/delete a staff document if the clinicId matches.
     * @deny (create) - Unauthenticated user cannot create a staff document.
     * @deny (update, delete) - Unauthenticated user cannot update/delete a staff document.
     * @principle Enforces clinic-based ownership for staff data.
     */
    match /clinics/{clinicId}/staff/{staffId} {
        function isSignedIn() {
            return request.auth != null;
        }

        function isClinic(clinicId) {
            return request.auth.uid == clinicId;
        }

        function isExistingClinic(clinicId) {
            return isClinic(clinicId) && resource != null;
        }

        allow get, list: if isSignedIn();
        allow create: if isSignedIn() && isClinic(clinicId);
        allow update: if isExistingClinic(clinicId);
        allow delete: if isExistingClinic(clinicId);
    }

    /**
     * @description Controls access to FAQ documents within a clinic.
     * @path /clinics/{clinicId}/faqs/{faqId}
     * @allow (create) - Authenticated user can create an FAQ document in the clinic if the clinicId matches.
     * @allow (get, list) - Read access is allowed for all authenticated users of the clinic.
     * @allow (update, delete) - Authenticated user can update/delete an FAQ document if the clinicId matches.
     * @deny (create) - Unauthenticated user cannot create an FAQ document.
     * @deny (update, delete) - Unauthenticated user cannot update/delete an FAQ document.
     * @principle Enforces clinic-based ownership for FAQ data.
     */
    match /clinics/{clinicId}/faqs/{faqId} {
        function isSignedIn() {
            return request.auth != null;
        }

        function isClinic(clinicId) {
            return request.auth.uid == clinicId;
        }

        function isExistingClinic(clinicId) {
            return isClinic(clinicId) && resource != null;
        }

        allow get, list: if isSignedIn();
        allow create: if isSignedIn() && isClinic(clinicId);
        allow update: if isExistingClinic(clinicId);
        allow delete: if isExistingClinic(clinicId);
    }

    /**
     * @description Controls access to chat session documents within a clinic.
     * @path /clinics/{clinicId}/chatSessions/{chatSessionId}
     * @allow (create) - Authenticated user can create a chat session document in the clinic if the clinicId matches.
     * @allow (get, list) - Read access is allowed for all authenticated users of the clinic.
     * @allow (update, delete) - Authenticated user can update/delete a chat session document if the clinicId matches.
     * @deny (create) - Unauthenticated user cannot create a chat session document.
     * @deny (update, delete) - Unauthenticated user cannot update/delete a chat session document.
     * @principle Enforces clinic-based ownership for chat session data.
     */
    match /clinics/{clinicId}/chatSessions/{chatSessionId} {
        function isSignedIn() {
            return request.auth != null;
        }

        function isClinic(clinicId) {
            return request.auth.uid == clinicId;
        }

        function isExistingClinic(clinicId) {
            return isClinic(clinicId) && resource != null;
        }

        allow get, list: if isSignedIn();
        allow create: if isSignedIn() && isClinic(clinicId);
        allow update: if isExistingClinic(clinicId);
        allow delete: if isExistingClinic(clinicId);
    }

    /**
     * @description Controls access to chat message documents within a chat session.
     * @path /clinics/{clinicId}/chatSessions/{chatSessionId}/chatMessages/{chatMessageId}
     * @allow (create) - Authenticated user can create a chat message document in the chat session if the clinicId matches.
     * @allow (get, list) - Read access is allowed for all authenticated users of the clinic.
     * @allow (update, delete) - Authenticated user can update/delete a chat message document if the clinicId matches.
     * @deny (create) - Unauthenticated user cannot create a chat message document.
     * @deny (update, delete) - Unauthenticated user cannot update/delete a chat message document.
     * @principle Enforces clinic-based ownership for chat message data.
     */
    match /clinics/{clinicId}/chatSessions/{chatSessionId}/chatMessages/{chatMessageId} {
        function isSignedIn() {
            return request.auth != null;
        }

        function isClinic(clinicId) {
            return request.auth.uid == clinicId;
        }

        function isExistingClinic(clinicId) {
            return isClinic(clinicId) && resource != null;
        }

        allow get, list: if isSignedIn();
        allow create: if isSignedIn() && isClinic(clinicId);
        allow update: if isExistingClinic(clinicId);
        allow delete: if isExistingClinic(clinicId);
    }
  }
}